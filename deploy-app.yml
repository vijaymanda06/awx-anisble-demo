---
- name: ğŸš€ Deploy via Raw Python (Boto3) - The Bulletproof Fix
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    # Get the list of Instance IDs from your inventory
    instance_list: "{{ groups['all'] | join(' ') }}"

  tasks:
    - name: ğŸ“ Create Python Deployment Script
      copy:
        dest: "/tmp/deploy_ssm.py"
        content: |
          import boto3
          import sys
          import time

          # 1. Get Instance IDs passed from Ansible
          instance_ids = sys.argv[1].split()
          region = 'us-east-1'

          print(f"ğŸš€ Target Instances: {instance_ids}")

          # 2. Connect to AWS SSM
          ssm = boto3.client('ssm', region_name=region)

          # 3. The Docker Command
          commands = [
              "sudo docker pull hashicorp/http-echo",
              "sudo docker rm -f showcase-app || true",
              "sudo docker run -d --name showcase-app -p 8080:5678 hashicorp/http-echo -text='<h1>ğŸš€ DevOps Success!</h1><p>Deployed via Raw Python & Boto3</p>'"
          ]

          # 4. Send the Command
          try:
              response = ssm.send_command(
                  InstanceIds=instance_ids,
                  DocumentName="AWS-RunShellScript",
                  Parameters={'commands': commands}
              )
              cmd_id = response['Command']['CommandId']
              print(f"âœ… Success! Command ID: {cmd_id}")
          except Exception as e:
              print(f"âŒ Failed: {str(e)}")
              sys.exit(1)

    - name: ğŸ“¡ Execute Deployment Script
      command: "python3 /tmp/deploy_ssm.py '{{ instance_list }}'"
      register: deploy_output

    - name: ğŸ“„ Show Result
      debug:
        msg: "{{ deploy_output.stdout_lines }}"
