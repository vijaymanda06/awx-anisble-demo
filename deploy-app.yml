---
- name: ğŸš€ Deploy via Raw Python (The "Silver Bullet" Fix)
  hosts: localhost
  connection: local
  gather_facts: no
  become: false
  vars:
    # Join the list of IPs into a single string
    instance_list: "{{ groups['all'] | join(' ') }}"

  tasks:
    - name: ğŸ“ Create Python Deployment Script
      copy:
        dest: "/tmp/deploy_ssm.py"
        mode: '0755'
        content: |
          import boto3
          import sys
          import time

          # 1. Parse Instance IDs
          try:
              instance_ids = sys.argv[1].split()
              if not instance_ids:
                  print("âŒ No instance IDs found!")
                  sys.exit(1)
          except IndexError:
               print("âŒ No instance IDs passed!")
               sys.exit(1)

          region = 'us-east-1'
          print(f"ğŸš€ Target Instances: {instance_ids}")

          # 2. Connect to AWS SSM
          # We use the existing credentials in the environment
          try:
              ssm = boto3.client('ssm', region_name=region)
          except Exception as e:
              print(f"âŒ AWS Connection Failed: {str(e)}")
              sys.exit(1)

          # 3. The Docker Command to run on EC2
          commands = [
              "sudo docker pull hashicorp/http-echo",
              "sudo docker rm -f showcase-app || true",
              "sudo docker run -d --name showcase-app -p 8080:5678 hashicorp/http-echo -text='<h1>ğŸš€ DevOps Success!</h1><p>Deployed via AWX Boto3 Bypass</p>'"
          ]

          # 4. Send the Command
          try:
              print("ğŸ“¡ Sending command to fleet...")
              response = ssm.send_command(
                  InstanceIds=instance_ids,
                  DocumentName="AWS-RunShellScript",
                  Parameters={'commands': commands}
              )
              cmd_id = response['Command']['CommandId']
              print(f"âœ… Success! Command ID: {cmd_id}")
          except Exception as e:
              print(f"âŒ Failed to send command: {str(e)}")
              sys.exit(1)

    - name: ğŸ“¡ Execute Deployment Script
      # creates: Use the python that Ansible is using (which definitely has boto3)
      command: "{{ ansible_playbook_python }} /tmp/deploy_ssm.py '{{ instance_list }}'"
      register: deploy_output

    - name: ğŸ“„ Show Result
      debug:
        msg: "{{ deploy_output.stdout_lines }}"
