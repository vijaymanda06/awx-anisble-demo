---
- name: ğŸ› ï¸ PRE-STEP - Install SSM Plugin on AWX Controller
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Download and Install SSM Plugin for the AWX Pod
      shell: |
        curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/linux_64bit/session-manager-plugin.rpm" -o "ssm.rpm"
        rpm -i --nodeps ssm.rpm
      args:
        creates: /usr/local/bin/session-manager-plugin
      become: true
      ignore_errors: yes

- name: ğŸš€ MAIN-STEP - Deploy Showcase App to Servers
  hosts: all
  become: yes
  tasks:
    - name: Ensure Docker container is running
      community.docker.docker_container:
        name: showcase-app
        image: hashicorp/http-echo
        state: started
        restart_policy: always
        command: "-text='<h1>ğŸš€ DevOps Success!</h1><p>Managed via AWX SSM Tunnel</p>'"
        published_ports:
          - "8080:5678"
